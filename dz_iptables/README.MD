# Домашняя работа по занятию "iptables"
1. реализовать knocking port
centralRouter может попасть на ssh inetrRouter через knock скрипт
пример в материалах.
2. добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
3. запустить nginx на centralServer.
4. пробросить 80й порт на inetRouter2 8080.
5. дефолт в инет оставить через inetRouter.

---
В качестве основы взят Vagrantfile из домашнего задания "Архитектура сетей"

## Knocking Port

На inetRouter правила iptables для порт кнокинга

```
root@inetRouter:~# cat /etc/iptables/rules.v4 
# Generated by iptables-save v1.8.7 on Thu Jul  4 04:37:16 2024
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:TRAFFIC - [0:0]
:SSH-INPUT - [0:0]
:SSH-INPUTTWO - [0:0]
COMMIT
# Completed on Thu Jul  4 04:37:16 2024
# Generated by iptables-save v1.8.7 on Thu Jul  4 04:37:16 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
# Completed on Thu Jul  4 04:37:16 2024
# TRAFFIC chain for Port Knocking.
-A INPUT -j TRAFFIC
-A SSH-INPUT -m recent --set --name SSH1 --mask 255.255.255.255 --rsource -j DROP
-A SSH-INPUTTWO -m recent --set --name SSH2 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p icmp -m icmp --icmp-type any -j ACCEPT
-A TRAFFIC -m state --state RELATED,ESTABLISHED -j ACCEPT
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 22 -m recent --rcheck --seconds 30 --name SSH2 --mask 255.255.255.255 --rsource -j ACCEPT
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH2 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 4444 -m recent --rcheck --name SSH1 --mask 255.255.255.255 --rsource -j SSH-INPUTTWO
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH1 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 3333 -m recent --rcheck --name SSH0 --mask 255.255.255.255 --rsource -j SSH-INPUT
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH0 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 2222 -m recent --set --name SSH0 --mask 255.255.255.255 --rsource -j DROP
-A TRAFFIC -j DROP
COMMIT
```

Включаем START_KNOCKD=1 в /etc/default/knockd 

```
vi /etc/default/knockd
# control if we start knockd at init or not
# 1 = start
# anything else = don't start
# PLEASE EDIT /etc/knockd.conf BEFORE ENABLING
START_KNOCKD=1

# command line options
#KNOCKD_OPTS="-i eth1"
```

Создаем юнит /etc/systemd/system/knockd.service для knockd 

```
[Unit]
Description=Port-Knock Daemon
After=network.target
Requires=network.target
Documentation=man:knockd(1)

[Service]
EnvironmentFile=-/etc/default/knockd
ExecStartPre=/usr/bin/sleep 1
ExecStart=/usr/sbin/knockd $KNOCKD_OPTS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
Restart=always
SuccessExitStatus=0 2 15
ProtectSystem=full
CapabilityBoundingSet=CAP_NET_RAW CAP_NET_ADMIN

[Install]
WantedBy=multi-user.target
```

Редактируем конфигурацию /etc/knockd.conf, оставляем options с интерфейсом и назначаем порты для кнока 

```
[options]
        UseSyslog
        Interface = eth1

[opencloseSSH]
        sequence      = 2222:tcp,3333:tcp,4444:tcp
        seq_timeout   = 15
        tcpflags      = syn
        start_command = /sbin/iptables -I INPUT 1 -s %IP% -p tcp --dport 22 -j ACCEPT
        cmd_timeout   = 30
        stop_command  = /sbin/iptables -D INPUT -s %IP% -p tcp --dport ssh -j ACCEPT
```

Запускаем `systemctl start knockd`

Пробуем подключиться с centralServer на inetRouter

```
root@centralServer:~# ssh vagrant@192.168.255.1
ssh: connect to host 192.168.255.1 port 22: Connection refused
```

Доступ закрыт, стучим (нужно также поставить knockd на centralServer)
```
root@centralServer:~# knock 192.168.255.1 2222 3333 4444
```
```
root@centralServer:~# ssh vagrant@192.168.255.1
vagrant@192.168.255.1's password: 
Last login: Thu Jul  4 04:53:32 2024 from 192.168.0.2
vagrant@inetRouter:~$ 
```

## Пробросить порт для nginx 

На CentralServer (192.168.0.2) установлен NGINX, чтобы пробросить его порт на inetRouter2 (192.168.255.14) нужно добавить правила

на inetRouter2
```
iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to 192.168.0.2:80
```
```
iptables -t nat -A POSTROUTING -o enp0s8 -p tcp -d 192.168.0.2 --dport 80 -j SNAT --to-source 192.168.255.14:8080
```

Автоматическая настройка добавлена в [плейбук](./ansible/playbook.yml)  